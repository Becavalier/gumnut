<!DOCTYPE html>
<html>
<head>
<script>

async function createWebAssembly(path, importObject) {
  const bytes = await window.fetch(path).then(x => x.arrayBuffer());
  return WebAssembly.instantiate(bytes, importObject);
}

const memory = new WebAssembly.Memory({initial: 256, maximum: 256});
const env = {
  'abortStackOverflow': () => { throw new Error('abortStackOverflow'); },
  'table': new WebAssembly.Table({initial: 0, maximum: 0, element: 'anyfunc'}),
  'tableBase': 0,
  'memory': memory,
  'memoryBase': 1024,
  'STACKTOP': 0,
  'STACK_MAX': memory.buffer.byteLength,
  'DYNAMICTOP_PTR': 0,
  'getTotalMemory': () => { console.info('getTotalMemory'); return 1; },
};
const importObject = {env};

const addException = (key) => env[key] = () => { throw new Error(key); };
const keys = 'abortStackOverflow';
// const keys = 'abort abortOnCannotGrowMemory abortStackOverflow enlargeMemory ___setErrNo _abort ___syscall140 _emscripten_memcpy_big ___lock ___syscall6';
keys.split(/\s+/).forEach(addException);


const ready = createWebAssembly('runner.wasm', importObject)
    .then(wa => wa.instance.exports)
    .catch(err => console.warn('err loading wasm', err));

function encodeToArray(s, array) {
  let i = 0;
  for (let si = 0; si < s.length; ++si) {
    const c = s.charCodeAt(si);
    if (c >= 128) {
      throw new Error('non-ascii not yet supported: ' + c);
    }
    array[i++] = c;
  }
  array[i++] = 0;
}

function copyToMemory(s) {
  const array = new Uint8Array(memory.buffer);
  const startAt = array.length - ((s.length + 1) * 4);
  const writeTo = new Uint8Array(memory.buffer, startAt);
  encodeToArray(s, writeTo);
  return startAt;
}

const TOKENS = {
  EOF: 0,
  ASI: 1,

  NEWLINE: 2,
  SEMICOLON: 3,
  SPREAD: 4,
  DOT: 5,
  OP: 6,
  ARROW: 7,
  ELISON: 8,
  COLON: 9,
  TERNARY: 10,
  BRACE: 11,
  ARRAY: 12,
  PAREN: 13,

  COMMENT: 14,
  STRING: 15,
  REGEXP: 16,
  NUMBER: 17,
  SYMBOL: 18,
  KEYWORD: 19,
  LABEL: 20,
};

const REVERSE = (function() {
  const m = new Map();
  Object.keys(TOKENS).forEach((key) => {
    m.set(TOKENS[key], key);
  });
  return m;
}());


window.addEventListener('load', (ev) => {
  const append = (text, type='') => {
    const node = document.createElement('span');
    node.textContent = text;
    node.className = type.toLowerCase();
    output.appendChild(document.createTextNode(' '));
    output.appendChild(node);
    return node;
  };

  const render = (tokens, raw) => {
    let lineNo = undefined;
    output.textContent = '';
    tokens.forEach(token => {
      if (token.lineNo !== lineNo) {
        lineNo = token.lineNo;
        append(token.lineNo, '_lineno');
      }

      // TODO: this works because the input is all ASCII right now
      const s = raw.substr(token.at, token.len);
      const node = append(s, REVERSE.get(token.type));

      switch (token.type) {
      case TOKENS.NEWLINE:
        return;
      case TOKENS.ASI:
        node.textContent = ';';
        break;
      }
    });
  };

  ready.then(exports => {
    const update = () => {
      const raw = input.value;
      const pointer = copyToMemory(raw);
      exports._prsr_setup(pointer);

      const tokens = [];
      const start = performance.now();
      for (;;) {
        const next = exports._prsr_run();
        if (next !== 0) {
          console.warn('got err at', next);
          break;
        }
        const token = {
          type: exports._prsr_get_type(),
          at: exports._prsr_get_at(),
          len: exports._prsr_get_len(),
          lineNo: exports._prsr_get_line_no(),
        };
        tokens.push(token);
        if (token.type === 0) {
          break;
        }
      }
      const took = performance.now() - start;
      stats.textContent = took.toLocaleString({minimumSignificantDigits: 8}) + 'ms';

      render(tokens, raw);
    };

    let rAF;
    const dedup = () => {
      window.cancelAnimationFrame(rAF);
      rAF = window.requestAnimationFrame(update);
    };
    input.oninput = dedup;
    dedup();
  });
});

</script>
<style>
  textarea {
    font-family: monospace;
    resize: none;
  }
  pre span._lineno {
    background: red;
    color: white;
  }
  pre span.asi {
    background: green;
    color: white;
  }
  pre span.comment {
    color: green;
  }
  pre span.keyword {
    color: purple;
  }
  pre span.number,
  pre span.string,
  pre span.regexp {
    color: red;
  }
</style>
</head>
<body>

<textarea id="input" rows="20" cols="100">var x = 1;
console.info(x);
++x;</textarea>

<div id="stats">
</div>

<pre id="output"></pre>

</body>
</html>